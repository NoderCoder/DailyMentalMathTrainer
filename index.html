import React, { useState, useEffect } from 'react';
import { Brain, TrendingUp, Calendar, Award, Clock, CheckCircle, LogIn, LogOut, UserPlus } from 'lucide-react';

// Firebase imports will be loaded from CDN
const firebaseConfig = {
  apiKey: "AIzaSyBEGSG5diAkel_r0wd33Eb8QJfHzOBJO7c",
  authDomain: "daily-mental-math-trainer.firebaseapp.com",
  projectId: "daily-mental-math-trainer",
  storageBucket: "daily-mental-math-trainer.firebasestorage.app",
  messagingSenderId: "854461237810",
  appId: "1:854461237810:web:e54a316092df5ca1304a2b"
};

export default function MentalMathTrainer() {
  const [currentScreen, setCurrentScreen] = useState('loading');
  const [user, setUser] = useState(null);
  const [userStats, setUserStats] = useState({
    streak: 0,
    totalSessions: 0,
    level: 1,
    lastCompletedDate: null,
    history: []
  });
  const [session, setSession] = useState(null);
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [userAnswer, setUserAnswer] = useState('');
  const [sessionResults, setSessionResults] = useState([]);
  const [timer, setTimer] = useState(0);
  const [sessionStartTime, setSessionStartTime] = useState(null);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [authMode, setAuthMode] = useState('login');
  const [authError, setAuthError] = useState('');
  const [firebase, setFirebase] = useState(null);

  const motivationalQuotes = [
    "Excellent work! Your mind is getting sharper every day. ðŸ§ ",
    "You're building a superpower one problem at a time! ðŸ’ª",
    "Consistency beats perfection. You showed up today! ðŸŒŸ",
    "Your brain is a muscle, and you just gave it a great workout! ðŸ‹ï¸",
    "Small daily improvements lead to stunning results! ðŸš€",
    "You're not just doing math, you're building mental agility! âš¡",
    "Every problem you solve makes the next one easier! ðŸ“ˆ",
    "Progress, not perfection. You're on the right path! ðŸŽ¯",
    "Your dedication today builds your confidence tomorrow! ðŸŒˆ",
    "Mathematics is the language of patterns. You're becoming fluent! ðŸ”¢"
  ];

  useEffect(() => {
    loadFirebase();
  }, []);

  useEffect(() => {
    let interval;
    if (session && sessionStartTime) {
      interval = setInterval(() => {
        setTimer(Math.floor((Date.now() - sessionStartTime) / 1000));
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [session, sessionStartTime]);

  const loadFirebase = async () => {
    try {
      await loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js');
      await loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js');
      await loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js');

      const app = window.firebase.initializeApp(firebaseConfig);
      setFirebase({
        auth: window.firebase.auth(),
        firestore: window.firebase.firestore()
      });

      window.firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          setUser(user);
          loadUserStats(user.uid);
          setCurrentScreen('home');
        } else {
          setUser(null);
          setCurrentScreen('auth');
        }
      });
    } catch (error) {
      console.error('Firebase initialization error:', error);
      setAuthError('Failed to initialize. Please check your Firebase configuration.');
      setCurrentScreen('auth');
    }
  };

  const loadScript = (src) => {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  };

  const loadUserStats = async (userId) => {
    try {
      const doc = await firebase.firestore.collection('users').doc(userId).get();
      if (doc.exists) {
        setUserStats(doc.data());
      }
    } catch (error) {
      console.error('Error loading stats:', error);
    }
  };

  const saveStats = async (newStats) => {
    try {
      await firebase.firestore.collection('users').doc(user.uid).set(newStats);
      setUserStats(newStats);
    } catch (error) {
      console.error('Error saving stats:', error);
    }
  };

  const handleAuth = async () => {
    setAuthError('');
    try {
      if (authMode === 'login') {
        await firebase.auth.signInWithEmailAndPassword(email, password);
      } else {
        await firebase.auth.createUserWithEmailAndPassword(email, password);
      }
    } catch (error) {
      setAuthError(error.message);
    }
  };

  const handleGoogleSignIn = async () => {
    try {
      const provider = new window.firebase.auth.GoogleAuthProvider();
      await firebase.auth.signInWithPopup(provider);
    } catch (error) {
      setAuthError(error.message);
    }
  };

  const handleLogout = async () => {
    await firebase.auth.signOut();
    setCurrentScreen('auth');
  };

  const startSession = () => {
    const today = new Date().toDateString();
    const lastCompleted = userStats.lastCompletedDate;
    
    let newStreak = userStats.streak;
    if (lastCompleted) {
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      if (lastCompleted === yesterday.toDateString()) {
        newStreak += 1;
      } else if (lastCompleted !== today) {
        newStreak = 1;
      }
    } else {
      newStreak = 1;
    }
    
    const questions = [];
    const availableTypes = getAvailableTypes(userStats.level);
    
    for (let i = 0; i < 20; i++) {
      const typeIndex = i % availableTypes.length;
      const forcedType = availableTypes[typeIndex];
      questions.push(generateQuestionOfType(userStats.level, forcedType));
    }
    
    questions.sort(() => Math.random() - 0.5);
    
    setSession(questions);
    setCurrentQuestion(0);
    setUserAnswer('');
    setSessionResults([]);
    setTimer(0);
    setSessionStartTime(Date.now());
    setCurrentScreen('practice');
  };

  const getAvailableTypes = (level) => {
    let types = ['addition', 'subtraction'];
    if (level >= 2) types.push('multiplication');
    if (level >= 3) types.push('division');
    if (level >= 4) types.push('double', 'half');
    if (level >= 6) types.push('square');
    if (level >= 8) types.push('percentage');
    return types;
  };

  const generateQuestionOfType = (level, type) => {
    let num1, num2, answer, question;
    const range = Math.min(10 + level * 5, 150);
    
    switch(type) {
      case 'addition':
        num1 = Math.floor(Math.random() * range) + 1;
        num2 = Math.floor(Math.random() * range) + 1;
        answer = num1 + num2;
        question = `${num1} + ${num2}`;
        break;
      case 'subtraction':
        num1 = Math.floor(Math.random() * range) + 1;
        num2 = Math.floor(Math.random() * num1) + 1;
        answer = num1 - num2;
        question = `${num1} - ${num2}`;
        break;
      case 'multiplication':
        num1 = Math.floor(Math.random() * Math.min(15, 5 + level)) + 1;
        num2 = Math.floor(Math.random() * Math.min(15, 5 + level)) + 1;
        answer = num1 * num2;
        question = `${num1} Ã— ${num2}`;
        break;
      case 'division':
        num2 = Math.floor(Math.random() * Math.min(12, 5 + level)) + 1;
        answer = Math.floor(Math.random() * Math.min(15, 5 + level)) + 1;
        num1 = num2 * answer;
        question = `${num1} Ã· ${num2}`;
        break;
      case 'square':
        num1 = Math.floor(Math.random() * Math.min(20, 8 + level)) + 1;
        answer = num1 * num1;
        question = `${num1}Â²`;
        break;
      case 'percentage':
        const percentages = [10, 20, 25, 50, 75];
        const percent = percentages[Math.floor(Math.random() * percentages.length)];
        num1 = Math.floor(Math.random() * Math.min(200, 50 + level * 10)) + 10;
        answer = Math.round((num1 * percent) / 100);
        question = `${percent}% of ${num1}`;
        break;
      case 'double':
        num1 = Math.floor(Math.random() * Math.min(100, 20 + level * 5)) + 1;
        answer = num1 * 2;
        question = `Double ${num1}`;
        break;
      case 'half':
        answer = Math.floor(Math.random() * Math.min(100, 20 + level * 5)) + 1;
        num1 = answer * 2;
        question = `Half of ${num1}`;
        break;
    }
    
    return { question, answer, type };
  };

  const submitAnswer = () => {
    const correct = parseInt(userAnswer) === session[currentQuestion].answer;
    const newResults = [...sessionResults, { 
      ...session[currentQuestion], 
      userAnswer: parseInt(userAnswer),
      correct,
      time: timer
    }];
    setSessionResults(newResults);
    
    if (currentQuestion < session.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
      setUserAnswer('');
    } else {
      completeSession(newResults);
    }
  };

  const completeSession = (results) => {
    const score = results.filter(r => r.correct).length;
    const accuracy = (score / results.length) * 100;
    const today = new Date().toDateString();
    const completionTime = timer;
    
    setSessionStartTime(null);
    
    let newLevel = userStats.level;
    if (accuracy >= 80 && userStats.level < 20) {
      newLevel += 1;
    } else if (accuracy < 50 && userStats.level > 1) {
      newLevel -= 1;
    }
    
    const newStats = {
      ...userStats,
      streak: userStats.lastCompletedDate === today ? userStats.streak : userStats.streak + 1,
      totalSessions: userStats.totalSessions + 1,
      level: newLevel,
      lastCompletedDate: today,
      history: [...userStats.history, {
        date: today,
        score,
        total: results.length,
        time: completionTime,
        level: userStats.level,
        timestamp: Date.now()
      }].slice(-30)
    };
    
    saveStats(newStats);
    setCurrentScreen('results');
  };

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  if (currentScreen === 'loading') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
        <div className="text-center">
          <Brain className="w-16 h-16 text-indigo-600 mx-auto mb-4 animate-pulse" />
          <p className="text-gray-600">Loading...</p>
        </div>
      </div>
    );
  }

  if (currentScreen === 'auth') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 flex items-center justify-center">
        <div className="max-w-md w-full bg-white rounded-2xl shadow-xl p-8">
          <div className="flex items-center justify-center mb-6">
            <Brain className="w-12 h-12 text-indigo-600 mr-3" />
            <h1 className="text-3xl font-bold text-gray-800">Mental Math</h1>
          </div>
          
          <p className="text-center text-gray-600 mb-6">
            {authMode === 'login' ? 'Sign in to sync your progress' : 'Create an account to get started'}
          </p>
          
          {authError && (
            <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm">
              {authError}
            </div>
          )}
          
          <div className="space-y-4 mb-4">
            <input
              type="email"
              placeholder="Email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handleAuth()}
              className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600"
            />
            <input
              type="password"
              placeholder="Password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handleAuth()}
              className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600"
            />
            <button
              onClick={handleAuth}
              className="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors"
            >
              {authMode === 'login' ? (
                <span className="flex items-center justify-center gap-2">
                  <LogIn className="w-5 h-5" />
                  Sign In
                </span>
              ) : (
                <span className="flex items-center justify-center gap-2">
                  <UserPlus className="w-5 h-5" />
                  Sign Up
                </span>
              )}
            </button>
          </div>
          
          <button
            onClick={handleGoogleSignIn}
            className="w-full bg-white border-2 border-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-50 transition-colors mb-4"
          >
            Sign in with Google
          </button>
          
          <button
            onClick={() => setAuthMode(authMode === 'login' ? 'signup' : 'login')}
            className="w-full text-indigo-600 text-sm hover:underline"
          >
            {authMode === 'login' ? "Don't have an account? Sign up" : 'Already have an account? Sign in'}
          </button>
        </div>
      </div>
    );
  }

  if (currentScreen === 'home') {
    const today = new Date().toDateString();
    const canPractice = userStats.lastCompletedDate !== today;
    
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
        <div className="max-w-2xl mx-auto">
          <div className="bg-white rounded-2xl shadow-xl p-8 mb-6">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center">
                <Brain className="w-12 h-12 text-indigo-600 mr-3" />
                <h1 className="text-3xl font-bold text-gray-800">Mental Math Trainer</h1>
              </div>
              <button
                onClick={handleLogout}
                className="text-gray-600 hover:text-gray-800 transition-colors"
                title="Logout"
              >
                <LogOut className="w-6 h-6" />
              </button>
            </div>
            
            <div className="bg-gray-50 rounded-lg p-3 mb-6 text-center">
              <p className="text-sm text-gray-600">Signed in as</p>
              <p className="font-semibold text-gray-800">{user?.email}</p>
            </div>
            
            <div className="grid grid-cols-3 gap-4 mb-8">
              <div className="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-4 text-center">
                <Calendar className="w-6 h-6 text-orange-600 mx-auto mb-2" />
                <div className="text-2xl font-bold text-orange-700">{userStats.streak}</div>
                <div className="text-sm text-orange-600">Day Streak</div>
              </div>
              
              <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 text-center">
                <Award className="w-6 h-6 text-green-600 mx-auto mb-2" />
                <div className="text-2xl font-bold text-green-700">{userStats.level}</div>
                <div className="text-sm text-green-600">Level</div>
              </div>
              
              <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4 text-center">
                <TrendingUp className="w-6 h-6 text-purple-600 mx-auto mb-2" />
                <div className="text-2xl font-bold text-purple-700">{userStats.totalSessions}</div>
                <div className="text-sm text-purple-600">Sessions</div>
              </div>
            </div>
            
            <button
              onClick={startSession}
              className="w-full py-4 rounded-xl font-semibold text-lg transition-all bg-indigo-600 text-white hover:bg-indigo-700 active:scale-95 mb-3"
            >
              {canPractice ? "Start Today's Practice" : "Practice More (Extra Session)"}
            </button>
            
            {!canPractice && (
              <p className="text-center text-gray-600 text-sm">
                âœ¨ You've completed today's lesson! Want to practice more?
              </p>
            )}
          </div>
          
          {userStats.history.length > 0 && (
            <div className="bg-white rounded-2xl shadow-xl p-6">
              <h2 className="text-xl font-bold text-gray-800 mb-4">Recent Progress</h2>
              <div className="space-y-2">
                {userStats.history.slice(-7).reverse().map((record, idx) => (
                  <div key={idx} className="flex items-center justify-between py-2 border-b last:border-0">
                    <span className="text-sm text-gray-600">{record.date}</span>
                    <div className="flex items-center gap-4">
                      <span className="text-sm font-medium">Level {record.level}</span>
                      <span className="text-sm font-semibold text-indigo-600">
                        {record.score}/{record.total} ({Math.round(record.score/record.total*100)}%)
                      </span>
                      <span className="text-sm text-gray-600 flex items-center gap-1">
                        <Clock className="w-4 h-4" />
                        {formatTime(record.time)}
                      </span>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    );
  }
  
  if (currentScreen === 'practice') {
    const progress = ((currentQuestion + 1) / session.length) * 100;
    
    return (
      <div className="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-100 p-4 flex items-center justify-center">
        <div className="max-w-lg w-full">
          <div className="bg-white rounded-2xl shadow-2xl p-8">
            <div className="flex justify-between items-center mb-6">
              <div className="flex items-center gap-2">
                <Clock className="w-5 h-5 text-gray-600" />
                <span className="font-mono text-lg">{formatTime(timer)}</span>
              </div>
              <span className="text-sm text-gray-600">
                Question {currentQuestion + 1} of {session.length}
              </span>
            </div>
            
            <div className="w-full bg-gray-200 rounded-full h-2 mb-8">
              <div 
                className="bg-indigo-600 h-2 rounded-full transition-all duration-300"
                style={{ width: `${progress}%` }}
              />
            </div>
            
            <div className="text-center mb-8">
              <div className="text-6xl font-bold text-gray-800 mb-8">
                {session[currentQuestion].question}
              </div>
              
              <input
                type="number"
                value={userAnswer}
                onChange={(e) => setUserAnswer(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && userAnswer && submitAnswer()}
                placeholder="Your answer"
                autoFocus
                className="w-full text-3xl text-center border-2 border-gray-300 rounded-xl p-4 focus:border-indigo-600 focus:outline-none"
              />
            </div>
            
            <button
              onClick={submitAnswer}
              disabled={!userAnswer}
              className="w-full bg-indigo-600 text-white py-4 rounded-xl font-semibold text-lg hover:bg-indigo-700 active:scale-95 transition-all disabled:bg-gray-300 disabled:cursor-not-allowed"
            >
              Submit
            </button>
          </div>
        </div>
      </div>
    );
  }
  
  if (currentScreen === 'results') {
    const score = sessionResults.filter(r => r.correct).length;
    const accuracy = Math.round((score / sessionResults.length) * 100);
    const randomQuote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
    
    let performanceMessage = "";
    if (accuracy === 100) performanceMessage = "Perfect score! You're unstoppable! ðŸŽ¯";
    else if (accuracy >= 90) performanceMessage = "Outstanding performance! Keep it up! ðŸŒŸ";
    else if (accuracy >= 80) performanceMessage = "Great job! You're making solid progress! ðŸ’ª";
    else if (accuracy >= 70) performanceMessage = "Nice work! You're improving steadily! ðŸ“ˆ";
    else performanceMessage = "Good effort! Practice makes progress! ðŸ’¡";
    
    return (
      <div className="min-h-screen bg-gradient-to-br from-green-50 to-emerald-100 p-4">
        <div className="max-w-2xl mx-auto">
          <div className="bg-white rounded-2xl shadow-2xl p-8 text-center">
            <CheckCircle className="w-16 h-16 text-green-600 mx-auto mb-4" />
            <h2 className="text-3xl font-bold text-gray-800 mb-2">Session Complete!</h2>
            <p className="text-lg text-gray-700 mb-2">{performanceMessage}</p>
            <p className="text-md text-gray-600 italic mb-8">"{randomQuote}"</p>
            
            <div className="grid grid-cols-3 gap-4 mb-8">
              <div className="bg-blue-50 rounded-xl p-4">
                <div className="text-3xl font-bold text-blue-700">{score}</div>
                <div className="text-sm text-blue-600">Correct</div>
              </div>
              
              <div className="bg-purple-50 rounded-xl p-4">
                <div className="text-3xl font-bold text-purple-700">{accuracy}%</div>
                <div className="text-sm text-purple-600">Accuracy</div>
              </div>
              
              <div className="bg-orange-50 rounded-xl p-4">
                <div className="text-3xl font-bold text-orange-700">{formatTime(timer)}</div>
                <div className="text-sm text-orange-600">Time</div>
              </div>
            </div>
            
            {accuracy >= 80 && userStats.level < 20 && (
              <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
                <p className="text-yellow-800 font-semibold">ðŸŽ‰ Level Up! You're now at Level {userStats.level}</p>
              </div>
            )}
            
            <div className="bg-gray-50 rounded-xl p-4 mb-6 max-h-60 overflow-y-auto">
              <h3 className="font-semibold text-gray-700 mb-3">Review</h3>
              {sessionResults.map((result, idx) => (
                <div key={idx} className={`flex items-center justify-between py-2 px-3 rounded mb-2 ${result.correct ? 'bg-green-50' : 'bg-red-50'}`}>
                  <span className="font-mono">{result.question} = {result.answer}</span>
                  <span className={`font-semibold ${result.correct ? 'text-green-700' : 'text-red-700'}`}>
                    {result.correct ? 'âœ“' : `âœ— (you: ${result.userAnswer})`}
                  </span>
                </div>
              ))}
            </div>
            
            <button
              onClick={() => setCurrentScreen('home')}
              className="w-full bg-indigo-600 text-white py-4 rounded-xl font-semibold text-lg hover:bg-indigo-700 active:scale-95 transition-all"
            >
              Back to Home
            </button>
          </div>
        </div>
      </div>
    );
  }
}
