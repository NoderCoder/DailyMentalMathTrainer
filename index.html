<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mental Math Trainer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body>
  <div id="app">
    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
      <div class="text-center">
        <div class="text-6xl mb-4 animate-pulse">üß†</div>
        <p class="text-gray-600">Loading...</p>
      </div>
    </div>
  </div>

  <!-- Load Firebase first -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // Wait for Firebase to load
    window.addEventListener('load', function() {
      // REPLACE WITH YOUR FIREBASE CONFIG
      const firebaseConfig = {
            apiKey: "AIzaSyBEGSG5diAkel_r0wd33Eb8QJfHzOBJO7c",
            authDomain: "daily-mental-math-trainer.firebaseapp.com",
            projectId: "daily-mental-math-trainer",
            storageBucket: "daily-mental-math-trainer.firebasestorage.app",
            messagingSenderId: "854461237810",
            appId: "1:854461237810:web:e54a316092df5ca1304a2b"
          };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      // State
      let currentScreen = 'loading';
      let currentUser = null;
      let userStats = {
        streak: 0,
        totalSessions: 0,
        level: 1,
        lastCompletedDate: null,
        history: []
      };
      let session = null;
      let currentQuestion = 0;
      let sessionResults = [];
      let timer = 0;
      let timerInterval = null;

      const motivationalQuotes = [
        "Excellent work! Your mind is getting sharper every day. üß†",
        "You're building a superpower one problem at a time! üí™",
        "Consistency beats perfection. You showed up today! üåü",
        "Your brain is a muscle, and you just gave it a great workout! üèãÔ∏è",
        "Small daily improvements lead to stunning results! üöÄ",
        "You're not just doing math, you're building mental agility! ‚ö°",
        "Every problem you solve makes the next one easier! üìà",
        "Progress, not perfection. You're on the right path! üéØ",
        "Your dedication today builds your confidence tomorrow! üåà",
        "Mathematics is the language of patterns. You're becoming fluent! üî¢"
      ];

      // Auth state listener
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          currentUser = user;
          await loadUserStats(user.uid);
          showScreen('home');
        } else {
          currentUser = null;
          showScreen('auth');
        }
      });

      async function loadUserStats(userId) {
        try {
          const doc = await db.collection('users').doc(userId).get();
          if (doc.exists) {
            userStats = doc.data();
          }
        } catch (error) {
          console.error('Error loading stats:', error);
        }
      }

      async function saveStats(newStats) {
        try {
          await db.collection('users').doc(currentUser.uid).set(newStats);
          userStats = newStats;
        } catch (error) {
          console.error('Error saving stats:', error);
        }
      }

      function showScreen(screen) {
        currentScreen = screen;
        render();
      }

      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      }

      function getAvailableTypes(level) {
        let types = ['addition', 'subtraction'];
        if (level >= 2) types.push('multiplication');
        if (level >= 3) types.push('division');
        if (level >= 4) types.push('double', 'half');
        if (level >= 6) types.push('square');
        if (level >= 8) types.push('percentage');
        return types;
      }

      function generateQuestionOfType(level, type) {
        let num1, num2, answer, question;
        const range = Math.min(10 + level * 5, 150);
        
        switch(type) {
          case 'addition':
            num1 = Math.floor(Math.random() * range) + 1;
            num2 = Math.floor(Math.random() * range) + 1;
            answer = num1 + num2;
            question = `${num1} + ${num2}`;
            break;
          case 'subtraction':
            num1 = Math.floor(Math.random() * range) + 1;
            num2 = Math.floor(Math.random() * num1) + 1;
            answer = num1 - num2;
            question = `${num1} - ${num2}`;
            break;
          case 'multiplication':
            num1 = Math.floor(Math.random() * Math.min(15, 5 + level)) + 1;
            num2 = Math.floor(Math.random() * Math.min(15, 5 + level)) + 1;
            answer = num1 * num2;
            question = `${num1} √ó ${num2}`;
            break;
          case 'division':
            num2 = Math.floor(Math.random() * Math.min(12, 5 + level)) + 1;
            answer = Math.floor(Math.random() * Math.min(15, 5 + level)) + 1;
            num1 = num2 * answer;
            question = `${num1} √∑ ${num2}`;
            break;
          case 'square':
            num1 = Math.floor(Math.random() * Math.min(20, 8 + level)) + 1;
            answer = num1 * num1;
            question = `${num1}¬≤`;
            break;
          case 'percentage':
            const percentages = [10, 20, 25, 50, 75];
            const percent = percentages[Math.floor(Math.random() * percentages.length)];
            num1 = Math.floor(Math.random() * Math.min(200, 50 + level * 10)) + 10;
            answer = Math.round((num1 * percent) / 100);
            question = `${percent}% of ${num1}`;
            break;
          case 'double':
            num1 = Math.floor(Math.random() * Math.min(100, 20 + level * 5)) + 1;
            answer = num1 * 2;
            question = `Double ${num1}`;
            break;
          case 'half':
            answer = Math.floor(Math.random() * Math.min(100, 20 + level * 5)) + 1;
            num1 = answer * 2;
            question = `Half of ${num1}`;
            break;
        }
        
        return { question, answer, type };
      }

      window.startSession = function() {
        const questions = [];
        const availableTypes = getAvailableTypes(userStats.level);
        
        for (let i = 0; i < 20; i++) {
          const typeIndex = i % availableTypes.length;
          const forcedType = availableTypes[typeIndex];
          questions.push(generateQuestionOfType(userStats.level, forcedType));
        }
        
        questions.sort(() => Math.random() - 0.5);
        
        session = questions;
        currentQuestion = 0;
        sessionResults = [];
        timer = 0;
        
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          timer++;
          const timerEl = document.getElementById('timer');
          if (timerEl) {
            timerEl.textContent = formatTime(timer);
          }
        }, 1000);
        
        showScreen('practice');
      };

      window.submitAnswer = function() {
        const input = document.getElementById('answer-input');
        const userAnswer = parseInt(input.value);
        
        if (isNaN(userAnswer) || input.value === '') return;
        
        const correct = userAnswer === session[currentQuestion].answer;
        sessionResults.push({
          ...session[currentQuestion],
          userAnswer,
          correct
        });
        
        if (currentQuestion < session.length - 1) {
          currentQuestion++;
          input.value = '';
          render();
          setTimeout(() => input.focus(), 100);
        } else {
          completeSession();
        }
      };

      async function completeSession() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
        
        const score = sessionResults.filter(r => r.correct).length;
        const accuracy = (score / sessionResults.length) * 100;
        const today = new Date().toDateString();
        const completionTime = timer;
        
        let newLevel = userStats.level;
        if (accuracy >= 80 && userStats.level < 20) {
          newLevel += 1;
        } else if (accuracy < 50 && userStats.level > 1) {
          newLevel -= 1;
        }
        
        const newStats = {
          ...userStats,
          streak: userStats.lastCompletedDate === today ? userStats.streak : userStats.streak + 1,
          totalSessions: userStats.totalSessions + 1,
          level: newLevel,
          lastCompletedDate: today,
          history: [...userStats.history, {
            date: today,
            score,
            total: sessionResults.length,
            time: completionTime,
            level: userStats.level,
            timestamp: Date.now()
          }].slice(-30)
        };
        
        await saveStats(newStats);
        showScreen('results');
      }

      window.handleAuth = async function(isSignup) {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('auth-error');
        
        errorDiv.classList.add('hidden');
        
        try {
          if (isSignup) {
            await auth.createUserWithEmailAndPassword(email, password);
          } else {
            await auth.signInWithEmailAndPassword(email, password);
          }
        } catch (error) {
          errorDiv.textContent = error.message;
          errorDiv.classList.remove('hidden');
        }
      };

      window.handleGoogleSignIn = async function() {
        try {
          const provider = new firebase.auth.GoogleAuthProvider();
          await auth.signInWithPopup(provider);
        } catch (error) {
          const errorDiv = document.getElementById('auth-error');
          errorDiv.textContent = error.message;
          errorDiv.classList.remove('hidden');
        }
      };

      window.handleLogout = function() {
        auth.signOut();
      };

      window.goHome = function() {
        showScreen('home');
      };

      function render() {
        const app = document.getElementById('app');
        
        if (currentScreen === 'loading') {
          app.innerHTML = `
            <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
              <div class="text-center">
                <div class="text-6xl mb-4 animate-pulse">üß†</div>
                <p class="text-gray-600">Loading...</p>
              </div>
            </div>
          `;
        }
        
        else if (currentScreen === 'auth') {
          app.innerHTML = `
            <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 flex items-center justify-center">
              <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-8">
                <div class="text-center mb-6">
                  <h1 class="text-3xl font-bold text-gray-800">üß† Mental Math Trainer</h1>
                  <p class="text-gray-600 mt-2" id="auth-subtitle">Sign in to sync your progress</p>
                </div>
                
                <div id="auth-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm"></div>
                
                <div class="space-y-4 mb-4">
                  <input type="email" id="email" placeholder="Email" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600">
                  <input type="password" id="password" placeholder="Password"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600"
                    onkeypress="if(event.key==='Enter') handleAuth(false)">
                  <button id="auth-button" onclick="handleAuth(false)"
                    class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                    Sign In
                  </button>
                </div>
                
                <button onclick="handleGoogleSignIn()"
                  class="w-full bg-white border-2 border-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-50 transition-colors mb-4">
                  Sign in with Google
                </button>
                
                <button id="toggle-auth" onclick="toggleAuthMode()"
                  class="w-full text-indigo-600 text-sm hover:underline">
                  Don't have an account? Sign up
                </button>
              </div>
            </div>
          `;
        }
        
        else if (currentScreen === 'home') {
          const today = new Date().toDateString();
          const canPractice = userStats.lastCompletedDate !== today;
          
          app.innerHTML = `
            <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
              <div class="max-w-2xl mx-auto">
                <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
                  <div class="flex items-center justify-between mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">üß† Mental Math Trainer</h1>
                    <button onclick="handleLogout()" 
                      class="text-gray-600 hover:text-gray-800 text-sm">
                      Logout
                    </button>
                  </div>
                  
                  <div class="bg-gray-50 rounded-lg p-3 mb-6 text-center">
                    <p class="text-sm text-gray-600">Signed in as</p>
                    <p class="font-semibold text-gray-800">${currentUser.email}</p>
                  </div>
                  
                  <div class="grid grid-cols-3 gap-4 mb-8">
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-4 text-center">
                      <div class="text-2xl mb-1">üìÖ</div>
                      <div class="text-2xl font-bold text-orange-700">${userStats.streak}</div>
                      <div class="text-sm text-orange-600">Day Streak</div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 text-center">
                      <div class="text-2xl mb-1">üèÜ</div>
                      <div class="text-2xl font-bold text-green-700">${userStats.level}</div>
                      <div class="text-sm text-green-600">Level</div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4 text-center">
                      <div class="text-2xl mb-1">üìà</div>
                      <div class="text-2xl font-bold text-purple-700">${userStats.totalSessions}</div>
                      <div class="text-sm text-purple-600">Sessions</div>
                    </div>
                  </div>
                  
                  <button onclick="startSession()"
                    class="w-full py-4 rounded-xl font-semibold text-lg transition-all bg-indigo-600 text-white hover:bg-indigo-700 active:scale-95 mb-3">
                    ${canPractice ? "Start Today's Practice" : "Practice More (Extra Session)"}
                  </button>
                  
                  ${!canPractice ? '<p class="text-center text-gray-600 text-sm">‚ú® You\'ve completed today\'s lesson! Want to practice more?</p>' : ''}
                </div>
                
                ${userStats.history.length > 0 ? `
                  <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Recent Progress</h2>
                    <div class="space-y-2">
                      ${userStats.history.slice(-7).reverse().map(record => `
                        <div class="flex items-center justify-between py-2 border-b last:border-0">
                          <span class="text-sm text-gray-600">${record.date}</span>
                          <div class="flex items-center gap-4">
                            <span class="text-sm font-medium">Level ${record.level}</span>
                            <span class="text-sm font-semibold text-indigo-600">
                              ${record.score}/${record.total} (${Math.round(record.score/record.total*100)}%)
                            </span>
                            <span class="text-sm text-gray-600">‚è±Ô∏è ${formatTime(record.time)}</span>
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        }
        
        else if (currentScreen === 'practice') {
          const progress = ((currentQuestion + 1) / session.length) * 100;
          
          app.innerHTML = `
            <div class="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-100 p-4 flex items-center justify-center">
              <div class="max-w-lg w-full">
                <div class="bg-white rounded-2xl shadow-2xl p-8">
                  <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-2">
                      <span>‚è±Ô∏è</span>
                      <span class="font-mono text-lg" id="timer">${formatTime(timer)}</span>
                    </div>
                    <span class="text-sm text-gray-600">
                      Question ${currentQuestion + 1} of ${session.length}
                    </span>
                  </div>
                  
                  <div class="w-full bg-gray-200 rounded-full h-2 mb-8">
                    <div class="bg-indigo-600 h-2 rounded-full transition-all duration-300" 
                      style="width: ${progress}%"></div>
                  </div>
                  
                  <div class="text-center mb-8">
                    <div class="text-6xl font-bold text-gray-800 mb-8">
                      ${session[currentQuestion].question}
                    </div>
                    
                    <input type="number" inputmode="numeric" pattern="[0-9]*" id="answer-input" placeholder="Your answer" autofocus
                      onkeypress="if(event.key==='Enter') submitAnswer()"
                      class="w-full text-3xl text-center border-2 border-gray-300 rounded-xl p-4 focus:border-indigo-600 focus:outline-none">
                  </div>
                  
                  <button onclick="submitAnswer()" id="submit-btn"
                    class="w-full bg-indigo-600 text-white py-4 rounded-xl font-semibold text-lg hover:bg-indigo-700 active:scale-95 transition-all">
                    Submit
                  </button>
                </div>
              </div>
            </div>
          `;
          
          setTimeout(() => {
            const input = document.getElementById('answer-input');
            if (input) {
              input.focus();
              // Force keyboard on mobile
              input.click();
            }
          }, 150);
        }
        
        else if (currentScreen === 'results') {
          const score = sessionResults.filter(r => r.correct).length;
          const accuracy = Math.round((score / sessionResults.length) * 100);
          const randomQuote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
          
          let performanceMessage = "";
          if (accuracy === 100) performanceMessage = "Perfect score! You're unstoppable! üéØ";
          else if (accuracy >= 90) performanceMessage = "Outstanding performance! Keep it up! üåü";
          else if (accuracy >= 80) performanceMessage = "Great job! You're making solid progress! üí™";
          else if (accuracy >= 70) performanceMessage = "Nice work! You're improving steadily! üìà";
          else performanceMessage = "Good effort! Practice makes progress! üí°";
          
          app.innerHTML = `
            <div class="min-h-screen bg-gradient-to-br from-green-50 to-emerald-100 p-4">
              <div class="max-w-2xl mx-auto">
                <div class="bg-white rounded-2xl shadow-2xl p-8 text-center">
                  <div class="text-6xl mb-4">‚úÖ</div>
                  <h2 class="text-3xl font-bold text-gray-800 mb-2">Session Complete!</h2>
                  <p class="text-lg text-gray-700 mb-2">${performanceMessage}</p>
                  <p class="text-md text-gray-600 italic mb-8">"${randomQuote}"</p>
                  
                  <div class="grid grid-cols-3 gap-4 mb-8">
                    <div class="bg-blue-50 rounded-xl p-4">
                      <div class="text-3xl font-bold text-blue-700">${score}</div>
                      <div class="text-sm text-blue-600">Correct</div>
                    </div>
                    
                    <div class="bg-purple-50 rounded-xl p-4">
                      <div class="text-3xl font-bold text-purple-700">${accuracy}%</div>
                      <div class="text-sm text-purple-600">Accuracy</div>
                    </div>
                    
                    <div class="bg-orange-50 rounded-xl p-4">
                      <div class="text-3xl font-bold text-orange-700">${formatTime(timer)}</div>
                      <div class="text-sm text-orange-600">Time</div>
                    </div>
                  </div>
                  
                  ${accuracy >= 80 && userStats.level < 20 ? `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
                      <p class="text-yellow-800 font-semibold">üéâ Level Up! You're now at Level ${userStats.level}</p>
                    </div>
                  ` : ''}
                  
                  <div class="bg-gray-50 rounded-xl p-4 mb-6 max-h-60 overflow-y-auto">
                    <h3 class="font-semibold text-gray-700 mb-3">Review</h3>
                    ${sessionResults.map(result => `
                      <div class="flex items-center justify-between py-2 px-3 rounded mb-2 ${result.correct ? 'bg-green-50' : 'bg-red-50'}">
                        <span class="font-mono">${result.question} = ${result.answer}</span>
                        <span class="font-semibold ${result.correct ? 'text-green-700' : 'text-red-700'}">
                          ${result.correct ? '‚úì' : `‚úó (you: ${result.userAnswer})`}
                        </span>
                      </div>
                    `).join('')}
                  </div>
                  
                  <button onclick="window.goHome()"
                    class="w-full bg-indigo-600 text-white py-4 rounded-xl font-semibold text-lg hover:bg-indigo-700 active:scale-95 transition-all">
                    Back to Home
                  </button>
                </div>
              </div>
            </div>
          `;
        }
      }

      let isSignupMode = false;
      window.toggleAuthMode = function() {
        isSignupMode = !isSignupMode;
        const subtitle = document.getElementById('auth-subtitle');
        const button = document.getElementById('auth-button');
        const toggle = document.getElementById('toggle-auth');
        
        if (isSignupMode) {
          subtitle.textContent = 'Create an account to get started';
          button.textContent = 'Sign Up';
          button.onclick = () => handleAuth(true);
          toggle.textContent = 'Already have an account? Sign in';
        } else {
          subtitle.textContent = 'Sign in to sync your progress';
          button.textContent = 'Sign In';
          button.onclick = () => handleAuth(false);
          toggle.textContent = "Don't have an account? Sign up";
        }
      };

      // Initial render
      render();
    });
  </script>
</body>
</html>
